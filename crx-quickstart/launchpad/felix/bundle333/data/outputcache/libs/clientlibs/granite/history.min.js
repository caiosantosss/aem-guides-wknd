/*
 2010-2011 Benjamin Arthur Lupton <contact@balupton.com>
 @license New BSD License <http://creativecommons.org/licenses/BSD/>
 Public Domain
 @author Benjamin Arthur Lupton <contact@balupton.com>
 @author James Padolsey <https://gist.github.com/527683>
 Public Domain
 @author Benjamin Arthur Lupton <contact@balupton.com>
*/
(function(e,q){var n=e.console||q,k=e.document,l=e.navigator,h=e.sessionStorage||!1,p=e.setTimeout,v=e.clearTimeout,w=e.setInterval,x=e.clearInterval,m=e.JSON,y=e.alert,a=e.History=e.History||{},t=e.history;try{h.setItem("TEST","1"),h.removeItem("TEST")}catch(r){h=!1}m.stringify=m.stringify||m.encode;m.parse=m.parse||m.decode;if("undefined"!==typeof a.init)throw Error("History.js Core has already been loaded...");a.init=function(r){if("undefined"===typeof a.Adapter)return!1;"undefined"!==typeof a.initCore&&
a.initCore();"undefined"!==typeof a.initHtml4&&a.initHtml4();return!0};a.initCore=function(r){if("undefined"!==typeof a.initCore.initialized)return!1;a.initCore.initialized=!0;a.options=a.options||{};a.options.hashChangeInterval=a.options.hashChangeInterval||100;a.options.safariPollInterval=a.options.safariPollInterval||500;a.options.doubleCheckInterval=a.options.doubleCheckInterval||500;a.options.disableSuid=a.options.disableSuid||!1;a.options.storeInterval=a.options.storeInterval||1E3;a.options.busyDelay=
a.options.busyDelay||250;a.options.debug=a.options.debug||!1;a.options.initialTitle=a.options.initialTitle||k.title;a.options.transformHash=a.options.transformHash||!0;a.options.html4Mode=a.options.html4Mode||!1;a.options.delayInit=a.options.delayInit||!1;a.intervalList=[];a.clearAllIntervals=function(){var b,c=a.intervalList;if("undefined"!==typeof c&&null!==c){for(b=0;b<c.length;b++)x(c[b]);a.intervalList=null}};a.debug=function(){a.options.debug&&a.log.apply(a,arguments)};a.log=function(){var b=
!("undefined"===typeof n||"undefined"===typeof n.log||"undefined"===typeof n.log.apply),c=k.getElementById("log"),d;if(b){var f=Array.prototype.slice.call(arguments);var g=f.shift();"undefined"!==typeof n.debug?n.debug.apply(n,[g,f]):n.log.apply(n,[g,f])}else g="\n"+arguments[0]+"\n";f=1;for(d=arguments.length;f<d;++f){var u=arguments[f];if("object"===typeof u&&"undefined"!==typeof m)try{u=m.stringify(u)}catch(z){}g+="\n"+u+"\n"}c?(c.value+=g+"\n-----\n",c.scrollTop=c.scrollHeight-c.clientHeight):
b||y(g);return!0};a.getInternetExplorerMajorVersion=function(){var b=a.getInternetExplorerMajorVersion;if("undefined"!==typeof a.getInternetExplorerMajorVersion.cached)var c=a.getInternetExplorerMajorVersion.cached;else{c=3;for(var d=k.createElement("div"),f=d.getElementsByTagName("i");(d.innerHTML="\x3c!--[if gt IE "+ ++c+"]\x3e\x3ci\x3e\x3c/i\x3e\x3c![endif]--\x3e")&&f[0];);c=4<c?c:!1}return b.cached=c};a.isInternetExplorer=function(){return a.isInternetExplorer.cached="undefined"!==typeof a.isInternetExplorer.cached?
a.isInternetExplorer.cached:!!a.getInternetExplorerMajorVersion()};a.emulated=a.options.html4Mode?{pushState:!0,hashChange:!0}:{pushState:!(e.history&&e.history.pushState&&e.history.replaceState&&!/ Mobile\/([1-7][a-z]|(8([abcde]|f(1[0-8]))))/i.test(l.userAgent)&&!/AppleWebKit\/5([0-2]|3[0-2])/i.test(l.userAgent)),hashChange:!(("onhashchange"in e||"onhashchange"in k)&&!(a.isInternetExplorer()&&8>a.getInternetExplorerMajorVersion()))};a.enabled=!a.emulated.pushState;a.bugs={setHash:!(a.emulated.pushState||
"Apple Computer, Inc."!==l.vendor||!/AppleWebKit\/5([0-2]|3[0-3])/.test(l.userAgent)),safariPoll:!(a.emulated.pushState||"Apple Computer, Inc."!==l.vendor||!/AppleWebKit\/5([0-2]|3[0-3])/.test(l.userAgent)),ieDoubleCheck:!!(a.isInternetExplorer()&&8>a.getInternetExplorerMajorVersion()),hashEscape:!!(a.isInternetExplorer()&&7>a.getInternetExplorerMajorVersion())};a.isEmptyObject=function(b){for(var c in b)if(b.hasOwnProperty(c))return!1;return!0};a.cloneObject=function(b){b?(b=m.stringify(b),b=m.parse(b)):
b={};return b};a.getRootUrl=function(){var b=k.location.protocol+"//"+(k.location.hostname||k.location.host);k.location.port&&(b+=":"+k.location.port);return b+"/"};a.getBaseHref=function(){var b=k.getElementsByTagName("base"),c="";1===b.length&&(b=b[0],c=b.href.replace(/[^\/]+$/,""));(c=c.replace(/\/+$/,""))&&(c+="/");return c};a.getBaseUrl=function(){return a.getBaseHref()||a.getBasePageUrl()||a.getRootUrl()};a.getPageUrl=function(){return((a.getState(!1,!1)||{}).url||a.getLocationHref()).replace(/\/+$/,
"").replace(/[^\/]+$/,function(b,c,d){return/\./.test(b)?b:b+"/"})};a.getBasePageUrl=function(){return a.getLocationHref().replace(/[#\?].*/,"").replace(/[^\/]+$/,function(b,c,d){return/[^\/]$/.test(b)?"":b}).replace(/\/+$/,"")+"/"};a.getFullUrl=function(b,c){var d=b,f=b.substring(0,1);c="undefined"===typeof c?!0:c;/[a-z]+:\/\//.test(b)||(d="/"===f?a.getRootUrl()+b.replace(/^\/+/,""):"#"===f?a.getPageUrl().replace(/#.*/,"")+b:"?"===f?a.getPageUrl().replace(/[\?#].*/,"")+b:c?a.getBaseUrl()+b.replace(/^(\.\/)+/,
""):a.getBasePageUrl()+b.replace(/^(\.\/)+/,""));return d.replace(/#$/,"")};a.getShortUrl=function(b){var c=a.getBaseUrl(),d=a.getRootUrl();a.emulated.pushState&&(b=b.replace(c,""));b=b.replace(d,"/");a.isTraditionalAnchor(b)&&(b="./"+b);return b=b.replace(/^(\.\/)+/g,"./").replace(/#$/,"")};a.getLocationHref=function(b){b=b||k;return b.URL===b.location.href?b.location.href:b.location.href===decodeURIComponent(b.URL)?b.URL:b.location.hash&&decodeURIComponent(b.location.href.replace(/^[^#]+/,""))===
b.location.hash||-1==b.URL.indexOf("#")&&-1!=b.location.href.indexOf("#")?b.location.href:b.URL||b.location.href};a.store={};a.idToState=a.idToState||{};a.stateToId=a.stateToId||{};a.urlToId=a.urlToId||{};a.storedStates=a.storedStates||[];a.savedStates=a.savedStates||[];a.normalizeStore=function(){a.store.idToState=a.store.idToState||{};a.store.urlToId=a.store.urlToId||{};a.store.stateToId=a.store.stateToId||{}};a.getState=function(b,c){"undefined"===typeof b&&(b=!0);"undefined"===typeof c&&(c=!0);
var d=a.getLastSavedState();!d&&c&&(d=a.createStateObject());b&&(d=a.cloneObject(d),d.url=d.cleanUrl||d.url);return d};a.getIdByState=function(b){var c=a.extractId(b.url);if(!c){var d=a.getStateString(b);if("undefined"!==typeof a.stateToId[d])c=a.stateToId[d];else if("undefined"!==typeof a.store.stateToId[d])c=a.store.stateToId[d];else{for(;c=(new Date).getTime()+String(Math.random()).replace(/\D/g,""),"undefined"!==typeof a.idToState[c]||"undefined"!==typeof a.store.idToState[c];);a.stateToId[d]=
c;a.idToState[c]=b}}return c};a.normalizeState=function(b){b&&"object"===typeof b||(b={});if("undefined"!==typeof b.normalized)return b;b.data&&"object"===typeof b.data||(b.data={});var c={normalized:!0};c.title=b.title||"";c.url=a.getFullUrl(b.url?b.url:a.getLocationHref());c.hash=a.getShortUrl(c.url);c.data=a.cloneObject(b.data);c.id=a.getIdByState(c);c.cleanUrl=c.url.replace(/\??&_suid.*/,"");c.url=c.cleanUrl;b=!a.isEmptyObject(c.data);(c.title||b)&&!0!==a.options.disableSuid&&(c.hash=a.getShortUrl(c.url).replace(/\??&_suid.*/,
""),/\?/.test(c.hash)||(c.hash+="?"),c.hash+="\x26_suid\x3d"+c.id);c.hashedUrl=a.getFullUrl(c.hash);(a.emulated.pushState||a.bugs.safariPoll)&&a.hasUrlDuplicate(c)&&(c.url=c.hashedUrl);return c};a.createStateObject=function(b,c,d){b={data:b,title:c,url:d};return b=a.normalizeState(b)};a.getStateById=function(b){b=String(b);return a.idToState[b]||a.store.idToState[b]||q};a.getStateString=function(b){b={data:a.normalizeState(b).data,title:b.title,url:b.url};return m.stringify(b)};a.getStateId=function(b){return a.normalizeState(b).id};
a.getHashByState=function(b){return a.normalizeState(b).hash};a.extractId=function(b){b=-1!=b.indexOf("#")?b.split("#")[0]:b;return((b=/(.*)&_suid=([0-9]+)$/.exec(b))?String(b[2]||""):"")||!1};a.isTraditionalAnchor=function(b){return!/[\/\?\.]/.test(b)};a.extractState=function(b,c){var d=null,f;c=c||!1;(f=a.extractId(b))&&(d=a.getStateById(f));if(!d){var g=a.getFullUrl(b);(f=a.getIdByUrl(g)||!1)&&(d=a.getStateById(f));d||!c||a.isTraditionalAnchor(b)||(d=a.createStateObject(null,null,g))}return d};
a.getIdByUrl=function(b){return a.urlToId[b]||a.store.urlToId[b]||q};a.getLastSavedState=function(){return a.savedStates[a.savedStates.length-1]||q};a.getLastStoredState=function(){return a.storedStates[a.storedStates.length-1]||q};a.hasUrlDuplicate=function(b){var c;return(c=a.extractState(b.url))&&c.id!==b.id};a.storeState=function(b){a.urlToId[b.url]=b.id;a.storedStates.push(a.cloneObject(b));return b};a.isLastSavedState=function(b){var c=!1;a.savedStates.length&&(b=b.id,c=a.getLastSavedState(),
c=c.id,c=b===c);return c};a.saveState=function(b){if(a.isLastSavedState(b))return!1;a.savedStates.push(a.cloneObject(b));return!0};a.getStateByIndex=function(b){return"undefined"===typeof b?a.savedStates[a.savedStates.length-1]:0>b?a.savedStates[a.savedStates.length+b]:a.savedStates[b]};a.getCurrentIndex=function(){return 1>a.savedStates.length?0:a.savedStates.length-1};a.getHash=function(b){b=a.getLocationHref(b);return a.getHashByUrl(b)};a.unescapeHash=function(b){b=a.normalizeHash(b);return b=
decodeURIComponent(b)};a.normalizeHash=function(b){return b.replace(/[^#]*#/,"").replace(/#.*/,"")};a.setHash=function(b,c){var d;if(!1!==c&&a.busy())return a.pushQueue({scope:a,callback:a.setHash,args:arguments,queue:c}),!1;a.busy(!0);(d=a.extractState(b,!0))&&!a.emulated.pushState?a.pushState(d.data,d.title,d.url,!1):a.getHash()!==b&&(a.bugs.setHash?(d=a.getPageUrl(),a.pushState(null,null,d+"#"+b,!1)):k.location.hash=b);return a};a.escapeHash=function(b){b=a.normalizeHash(b);b=e.encodeURIComponent(b);
a.bugs.hashEscape||(b=b.replace(/%21/g,"!").replace(/%26/g,"\x26").replace(/%3D/g,"\x3d").replace(/%3F/g,"?"));return b};a.getHashByUrl=function(b){b=String(b).replace(/([^#]*)#?([^#]*)#?(.*)/,"$2");return b=a.unescapeHash(b)};a.setTitle=function(b){var c=b.title,d;c||(d=a.getStateByIndex(0))&&d.url===b.url&&(c=d.title||a.options.initialTitle);try{k.getElementsByTagName("title")[0].innerHTML=c.replace("\x3c","\x26lt;").replace("\x3e","\x26gt;").replace(" \x26 "," \x26amp; ")}catch(f){}k.title=c;return a};
a.queues=[];a.busy=function(b){"undefined"!==typeof b?a.busy.flag=b:"undefined"===typeof a.busy.flag&&(a.busy.flag=!1);if(!a.busy.flag){v(a.busy.timeout);var c=function(){var d;if(!a.busy.flag)for(d=a.queues.length-1;0<=d;--d){var f=a.queues[d];0!==f.length&&(f=f.shift(),a.fireQueueItem(f),a.busy.timeout=p(c,a.options.busyDelay))}};a.busy.timeout=p(c,a.options.busyDelay)}return a.busy.flag};a.busy.flag=!1;a.fireQueueItem=function(b){return b.callback.apply(b.scope||a,b.args||[])};a.pushQueue=function(b){a.queues[b.queue||
0]=a.queues[b.queue||0]||[];a.queues[b.queue||0].push(b);return a};a.queue=function(b,c){"function"===typeof b&&(b={callback:b});"undefined"!==typeof c&&(b.queue=c);a.busy()?a.pushQueue(b):a.fireQueueItem(b);return a};a.clearQueue=function(){a.busy.flag=!1;a.queues=[];return a};a.stateChanged=!1;a.doubleChecker=!1;a.doubleCheckComplete=function(){a.stateChanged=!0;a.doubleCheckClear();return a};a.doubleCheckClear=function(){a.doubleChecker&&(v(a.doubleChecker),a.doubleChecker=!1);return a};a.doubleCheck=
function(b){a.stateChanged=!1;a.doubleCheckClear();a.bugs.ieDoubleCheck&&(a.doubleChecker=p(function(){a.doubleCheckClear();a.stateChanged||b();return!0},a.options.doubleCheckInterval));return a};a.safariStatePoll=function(){var b=a.extractState(a.getLocationHref());if(!a.isLastSavedState(b))return b||a.createStateObject(),a.Adapter.trigger(e,"popstate"),a};a.back=function(b){if(!1!==b&&a.busy())return a.pushQueue({scope:a,callback:a.back,args:arguments,queue:b}),!1;a.busy(!0);a.doubleCheck(function(){a.back(!1)});
t.go(-1);return!0};a.forward=function(b){if(!1!==b&&a.busy())return a.pushQueue({scope:a,callback:a.forward,args:arguments,queue:b}),!1;a.busy(!0);a.doubleCheck(function(){a.forward(!1)});t.go(1);return!0};a.go=function(b,c){var d;if(0<b)for(d=1;d<=b;++d)a.forward(c);else if(0>b)for(d=-1;d>=b;--d)a.back(c);else throw Error("History.go: History.go requires a positive or negative integer passed.");return a};a.emulated.pushState?(r=function(){},a.pushState=a.pushState||r,a.replaceState=a.replaceState||
r):(a.onPopState=function(b,c){var d;a.doubleCheckComplete();if(d=a.getHash())return b=a.extractState(d||a.getLocationHref(),!0),a.options.transformHash&&b?a.replaceState(b.data,b.title,b.url,!1):(a.Adapter.trigger(e,"anchorchange"),a.busy(!1)),a.expectedStateId=!1;(b=(b=a.Adapter.extractEventData("state",b,c)||!1)?a.getStateById(b):a.expectedStateId?a.getStateById(a.expectedStateId):a.extractState(a.getLocationHref()))||(b=a.createStateObject(null,null,a.getLocationHref()));a.expectedStateId=!1;
if(a.isLastSavedState(b))return a.busy(!1),!1;a.storeState(b);a.saveState(b);a.setTitle(b);a.Adapter.trigger(e,"statechange");a.busy(!1);return!0},a.Adapter.bind(e,"popstate",a.onPopState),a.pushState=function(b,c,d,f){if(a.getHashByUrl(d)&&a.emulated.pushState)throw Error("History.js does not support states with fragement-identifiers (hashes/anchors).");if(!1!==f&&a.busy())return a.pushQueue({scope:a,callback:a.pushState,args:arguments,queue:f}),!1;a.busy(!0);var g=a.createStateObject(b,c,d);a.isLastSavedState(g)?
a.busy(!1):(a.storeState(g),a.expectedStateId=g.id,t.pushState(g.id,g.title,g.url),a.Adapter.trigger(e,"popstate"));return!0},a.replaceState=function(b,c,d,f){if(a.getHashByUrl(d)&&a.emulated.pushState)throw Error("History.js does not support states with fragement-identifiers (hashes/anchors).");if(!1!==f&&a.busy())return a.pushQueue({scope:a,callback:a.replaceState,args:arguments,queue:f}),!1;a.busy(!0);var g=a.createStateObject(b,c,d);a.isLastSavedState(g)?a.busy(!1):(a.storeState(g),a.expectedStateId=
g.id,t.replaceState(g.id,g.title,g.url),a.Adapter.trigger(e,"popstate"));return!0});if(h)try{a.store=m.parse(h.getItem("History.store"))||{}}catch(b){a.store={}}else a.store={};a.normalizeStore();a.Adapter.bind(e,"unload",a.clearAllIntervals);a.saveState(a.storeState(a.extractState(a.getLocationHref(),!0)));h&&(a.onUnload=function(){var b;try{var c=m.parse(h.getItem("History.store"))||{}}catch(d){c={}}c.idToState=c.idToState||{};c.urlToId=c.urlToId||{};c.stateToId=c.stateToId||{};for(b in a.idToState)a.idToState.hasOwnProperty(b)&&
(c.idToState[b]=a.idToState[b]);for(b in a.urlToId)a.urlToId.hasOwnProperty(b)&&(c.urlToId[b]=a.urlToId[b]);for(b in a.stateToId)a.stateToId.hasOwnProperty(b)&&(c.stateToId[b]=a.stateToId[b]);a.store=c;a.normalizeStore();c=m.stringify(c);try{h.setItem("History.store",c)}catch(d){if(d.code===DOMException.QUOTA_EXCEEDED_ERR)h.length&&(h.removeItem("History.store"),h.setItem("History.store",c));else throw d;}},a.intervalList.push(w(a.onUnload,a.options.storeInterval)),a.Adapter.bind(e,"beforeunload",
a.onUnload),a.Adapter.bind(e,"unload",a.onUnload));if(!a.emulated.pushState&&(a.bugs.safariPoll&&a.intervalList.push(w(a.safariStatePoll,a.options.safariPollInterval)),"Apple Computer, Inc."===l.vendor||"Mozilla"===(l.appCodeName||""))&&(a.Adapter.bind(e,"hashchange",function(){a.Adapter.trigger(e,"popstate")}),a.getHash()))a.Adapter.onDomLoad(function(){a.Adapter.trigger(e,"hashchange")})};a.options&&a.options.delayInit||a.init()})(window);
(function(e,q){var n=e.History=e.History||{},k=e.jQuery;if("undefined"!==typeof n.Adapter)throw Error("History.js Adapter has already been loaded...");n.Adapter={bind:function(l,h,p){k(l).bind(h,p)},trigger:function(l,h,p){k(l).trigger(h,p)},extractEventData:function(l,h,p){return h&&h.originalEvent&&h.originalEvent[l]||p&&p[l]||q},onDomLoad:function(l){k(l)}};"undefined"!==typeof n.init&&n.init()})(window);