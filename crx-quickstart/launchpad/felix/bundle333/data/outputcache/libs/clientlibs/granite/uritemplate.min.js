(function(p){function t(a,c){for(var b=[],g=a.current();g&&c(g);)b.push(g),g=a.next();return b.join("")}function u(a){return"0"<=a&&"9">=a}function w(a){return"A"<=a&&"Z">=a||"a"<=a&&"z">=a||u(a)||"_"===a||"%"===a}function z(a){return w(a)||"."===a}function m(a){return encodeURIComponent(a).replace(A,function(c){return"%"+c.charCodeAt(0).toString(16).toUpperCase()})}function l(a){for(var c=[],b=0,g=a.length;b<g;b++){var e=a[b],d=e;"A"<=d&&"Z">=d||"a"<=d&&"z">=d||u(d)||"-"===d||"."===d||"_"===d||"~"===
d||0<=B.indexOf(e)?c.push(e):"%"===e?c.push(e,a[++b],a[++b]):"\ud800"<=e&&"\udbff">=e||"\udc00"<=e&&"\udfff">=e?c.push(encodeURIComponent(e+a[++b])):c.push(m(e))}return c.join("")}function C(a){var c=a[0];if(c){if(0<=D.indexOf(c)){if(0>x.indexOf(c))return}else if(w(c))c="NUL";else return;switch(c){case "NUL":return{op:"",varspeclist:a,first:"",sep:",",named:!1,ifemp:"",encode:m};case "+":return{op:"+",varspeclist:a.substring(1),first:"",sep:",",named:!1,ifemp:"",encode:l};case ".":case "/":return{op:a[0],
varspeclist:a.substring(1),first:a[0],sep:a[0],named:!1,ifemp:"",encode:m};case ";":return{op:";",varspeclist:a.substring(1),first:";",sep:";",named:!0,ifemp:"",encode:m};case "?":return{op:"?",varspeclist:a.substring(1),first:"?",sep:"\x26",named:!0,ifemp:"\x3d",encode:m};case "\x26":return{op:"\x26",varspeclist:a.substring(1),first:"\x26",sep:"\x26",named:!0,ifemp:"\x3d",encode:m};case "#":return{op:"#",varspeclist:a.substring(1),first:"#",sep:",",named:!1,ifemp:"",encode:l}}}}function E(a){for(var c=
["{","}"],b=0,g=function(d){if(0<b){if(!(u(d)||"A"<=d&&"F">=d||"a"<=d&&"f">=d))return!1;3===++b&&(b=0);return!0}return"%"===d?(b++,!0):0>c.indexOf(d)&&"!"<=d};a.hasNext();){a.next();var e=t(a,g);a.append(l(e));"{"===a.current()?F(a):(a.hasNext()||0<b)&&a.halt("Malform expression")}}function F(a){a.next();var c=t(a,function(G){return"}"!==G});"}"!==a.current()&&(a.append("{",c),a.halt("Malform expression"));var b=C(c);if(b)for(var g=b.varspeclist,e=-1,d,h={current:function(){return d},hasNext:function(){return e<
g.length},next:function(){return d=g[++e]}},k=!0;h.hasNext();){h.next();var q=t(h,z),v=null,r=null;if(h.hasNext()){if("*"===h.current())v=h.current(),h.next();else if(":"===h.current()&&(v=h.current(),h.next(),r=parseInt(t(h,u),10),isNaN(r))){a.fail("{",c,"}");break}if(h.hasNext()&&","!==h.current()){a.fail("{",c,"}");break}}else if(0===q.length)break;var f=a.value(q);if(!(void 0===f||null===f||Array.isArray(f)&&0===f.length||"object"===typeof f&&0===Object.keys(f).length))if("number"===typeof f&&
(f=f.toString()),k?(a.append(b.first),k=!1):a.append(b.sep),"string"===typeof f){if(b.named){a.append(l(q));if(0===f.length){a.append(b.ifemp);continue}a.append("\x3d")}":"===v&&r<f.length?a.append(b.encode(f.substring(0,r))):a.append(b.encode(f))}else if("*"!==v){if(b.named){a.append(l(q));if(0===f.length){a.append(b.ifemp);continue}a.append("\x3d")}if(Array.isArray(f))a.append(f.map(b.encode).join(","));else if("object"===typeof f){if(null!==r){a.fail("{",c,"}");break}y(f,b.encode,a,",",",")}}else b.named?
Array.isArray(f)?H(q,f,a,b):"object"===typeof f&&I(f,a,b):Array.isArray(f)?a.append(f.map(b.encode).join(b.sep)):"object"===typeof f&&y(f,b.encode,a,"\x3d",b.sep)}else a.fail("{",c,"}")}function H(a,c,b,g){var e=!0;c.forEach(function(d){void 0!==d&&null!==d&&(e?e=!1:b.append(g.sep),b.append(l(a)),0===d.length?b.append(g.ifemp):b.append("\x3d",g.encode(d)))})}function I(a,c,b){var g=!0;Object.keys(a).forEach(function(e){var d=a[e];void 0!==d&&null!==d&&(g?g=!1:c.append(b.sep),c.append(l(e)),0===d.length?
c.append(b.ifemp):c.append("\x3d",b.encode(d)))})}function y(a,c,b,g,e){var d=!0;Object.keys(a).forEach(function(h){var k=a[h];void 0!==k&&null!==k&&(d?d=!1:b.append(e),b.append(c(h),g,c(k)))})}function n(a){this.name="URITemplateError";this.message=a}var B=":/?#[]@!$\x26'()*+,;\x3d".split(""),A=/[!'()*]/g,x="+#./;?\x26".split(""),D=x.concat(["\x3d",",","!","@","|"]);n.prototype=Error();n.prototype.constructor=n;p.URITemplateError=n;p.expand=function(a,c){c=c||{};var b=!1,g="",e=-1,d;E({fail:function(){b=
!0;this.append.apply(this,arguments)},halt:function(h){b=!0;throw new n(h+": "+g);},append:function(){for(var h=0,k=arguments.length;h<k;h++)g+=arguments[h]},current:function(){return d},hasNext:function(){return e<a.length},next:function(){return d=a[++e]},value:function(h){return c[h]}});if(b)throw new n("Invalid template: "+g);return g}})("object"===typeof module&&module.exports?module.exports:function(){var p=window.Granite=window.Granite||{};p.URITemplate={};return p.URITemplate}());